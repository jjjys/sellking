## Building Register API Server Maintenance Guide
GUI, CLI 환경 차이로 인해 윈도우(GUI) 환경에서 코드 수정 및 테스트 진행 후 배포하는 과정으로 진행.

### 유지보수 작업 대상
1. LLM api 사용 코드 업데이트 및 모델 변경(gpt, gemini)
2. 정부24 html 태그 변경 업데이트
3. 그 외 서비스 운영에 필요한 작업(서비스 개선, 확장 등)

### 서버 운영 흐름(Runtime Workflow)

- **서버 초기화 및 로그인**:
    - Docker 컨테이너 시작 시 lifespan 함수에서 Selenium 드라이버 초기화.
    - .env 파일에서 GOV24_ID/PW 로드 후 login_gov24 호출: 로그인 페이지 이동 → ID 입력 → 캡챠 이미지 저장 및 Gemini API로 해결 → PW 및 캡챠 입력 → 로그인 버튼 클릭.
    - 실패 시 재시도 (최대 3회). 성공 시 상태 유지.
- **API 요청 수신 및 페이지 세팅**:
    - /render_building_register 엔드포인트 호출 시 입력 데이터(address, dong, num) 수신.
    - building_register_issuance_settings 호출: 정부24 발급 페이지 이동 → "발급하기" 버튼 클릭 → 집합건물/전유부 선택 등 세팅.
    - 로그인 상태 체크: 만료 시 재로그인.
- **주소/동/호수 검색 및 AI 예측**:
    - search_address: 주소 입력 → 검색 → 결과 확인. 행정기관 추가 선택 필요 시 처리.
    - search_dong: 동 리스트 추출 → 선택지 2개 이상 시 OpenAI API 호출로 예측 (프롬프트 기반 유사성 판단).
    - search_num: 호수 리스트 추출 → 선택지 2개 이상 시 OpenAI API 호출로 예측.
    - AI 응답 검증: JSON 형식 확인, 신뢰도(높음/중간/낮음) 기반 선택.
- **서류 발급 및 응답**:
    - get_building_register: 선택된 동/호수로 발급 신청 → 새 창에서 HTML 추출 및 전처리.
    - HTML 응답 반환. 실패 시 에러 로그.

### 타겟 시나리오 및 예외(정부 24 유스케이스)
주소, 동, 호수 각각 시나리오에서 원하는 케이스 외 추가적으로 나오는 경우 확인 후 예외 처리.

#### 주소
1.주소 안나오는 경우
2.행정처리기관(더 선택해야 하는 경우)
    행정처리기관 추가 선택 필요
        예)
        인천광역시 연수구 아트센터대로 131
        인천광역시 서구 검암로2번길 41-5
        경기 평택 ~
**3.정상적으로 주소 검색결과 출력(원하는 케이스)**

#### 동
1.동 검색결과 없음(경고창 알림)
2.동 검색결과 선택지 1개(True)
3.동 검색결과 선택지 2개 이상(AI로 예측 진행
    1.동 선택지에 없는 값으로 예측하는 경우
    2.동 선택지에 있는 값으로 예측하는 경우(True)
        **1.맞춤(원하는 케이스)**
        2.예측 실패
    3.정해진 답변 형식(json)으로 답변하지 않는 경우

#### 호수
호수 검색결과 선택지 1개(True)
호수 검색결과 선택지 2개 이상(AI로 예측 진행)
    1.호수 선택지에 없는 값으로 예측하는 경우
    2.호수 선택지에 있는 값으로 예측하는 경우
        **1.맞춤(원하는 케이스)**
        2.예측 실패
    3.정해진 답변 형식(json)으로 답변하지 않는 경우


### 수정 후 배포 작업 순서
1.dock 이미지 빌드 및 tar 파일 생성
2.GCP vm 인스턴스(COS)에 tar 파일 전송
3.docker 이미지 로드
4.docker-compose up으로 서버 실행
	docker-compose 안되는 경우(아래 진행)
		source ~/.bashrc
		docker-compose version 

### 유지보수 시 주의사항
1. "driver_call.py" 파일 GUI 환경에서 디버깅 시 아래 항목 주석
	options.add_argument('--headless')
	options.binary_location = "/usr/bin/google-chrome" 

2. headless 옵션 미사용 시
	크롬 브라우저에서 뷰포트 문제로 에러나는 경우가 발생하기 때문에 크롬 브라우저 화면에 보여지는 상태에서 진행해야함.

3. 정부24 계정 사용
	정부24 계정 1개를 활용하는 것이기 때문에 여러 ip에서 빠른 시간에 반복적인 로그인 하는 경우 해당 계정이 제재를 받을 수 있음. 

### 참고자료
1. 건축물대장 자동발급 api 서버 개발 시연 영상